<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>Installing Parabola GNU/Linux-libre With Full Disk Encryption on UEFI With GRUB</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="../stylesheets/article.css" media="screen">
</head>
<body>
<h1 style="color: red">WARNING: THIS IS INCOMPLETE! USE AT YOUR OWN RISK!</h1>
<h1>Installing Parabola GNU/Linux-libre With Full Disk Encryption on UEFI With GRUB</h1>
<p>Note: Many parts of this tutorial are taken from the ArchWiki.</p>
<h2>1. The Base Install</h2>
<h3>Setup the Partitions</h3>
<p>Note: It is assumed that <code>/dev/sda</code> is your harddrive.</p>
<pre><code>+---------------+----------------+----------------+----------------+----------------+
|ESP partition: |Boot partition: |Volume 1:       |Volume 2:       |Volume 3:       |
|               |                |                |                |                |
|/boot/efi      |/boot           |root            |swap            |home            |
|               |                |                |                |                |
|               |                |/dev/store/root |/dev/store/swap |/dev/store/home |
|/dev/sdaX      |/dev/sdaY       +----------------+----------------+----------------+
|unencrypted    |LUKS encrypted  |/dev/sdaZ encrypted using LVM on LUKS             |
+---------------+----------------+--------------------------------------------------+
</code></pre>
<h4>Create the Partitions</h4>
<p>I'll use the tool <code>gdisk</code> for this:</p>
<pre><code># gdisk /dev/sda
</code></pre>
<p>Note that an empty space after a command below means that you just press enter immediately to accept the default.</p>
<p>Create a 512MB partition, <code>/dev/sdaX</code>, with the type code <code>EF00</code>.</p>
<pre><code>Command (? for help): n
Partition number (1-128, default 1):
First sector (1-2047, default = 1) or {+-}size{KMGTP}:
Last sector (1-2047, default = 2047) or {+-}size{KMGTP}: 512M
Current type is 'Linux filesystem'
Hex code or GUID (L to show codes, Enter = 8300): EF00
Changed type of partition to 'EFI System'
</code></pre>
<p>Create a 512MB partition, <code>/dev/sdaY</code>, with the type code <code>8300</code>.</p>
<pre><code>Command (? for help): n
Partition number (2-128, default 2):
First sector (513-2047, default = 513) or {+-}size{KMGTP}:
Last sector (513-2047, default = 2047) or {+-}size{KMGTP}: 512M
Current type is 'Linux filesystem'
Hex code or GUID (L to show codes, Enter = 8300):
Changed type of partition to 'EFI System'
</code></pre>
<p>Create a partition filling the rest of the space, <code>/dev/sdaZ</code>, with the type code <code>8E00</code>.</p>
<pre><code>Command (? for help): n
Partition number (3-128, default 3):
First sector (1025-2047, default = 1025) or {+-}size{KMGTP}:
Last sector (1025-2047, default = 2047) or {+-}size{KMGTP}:
Current type is 'Linux filesystem'
Hex code or GUID (L to show codes, Enter = 8300): 8E00
Changed type of partition to 'Linux LVM'
</code></pre>
<p>Encrypt the <code>/dev/sdaZ</code> partition:</p>
<pre><code># cryptsetup luksFormat /dev/sdaX
</code></pre>
<p>Format <code>/dev/sdaX</code>:</p>
<pre><code># mkfs.vfat -F32 /dev/sdaX
</code></pre>
<h4>Setup the Logical Volumes</h4>
<p>Open <code>/dev/sdaZ</code>:</p>
<pre><code># cryptsetup open --type luks /dev/sdaZ lvm
</code></pre>
<p>The decrypted container is now available at <code>/dev/mapper/lvm</code>.</p>
<p>Create a physical volume on top of the opened LUKS container:</p>
<pre><code># pvcreate /dev/mapper/lvm
</code></pre>
<p>Create the volume group named <code>MyVol</code> (or whatever you want), adding the previously created physical volume to it:</p>
<pre><code># vgcreate MyVol /dev/mapper/lvm
</code></pre>
<p>Create your logical volumes in this volume group:</p>
<pre><code># lvcreate -L 8G MyVol -n swap
# lvcreate -L 15G MyVol -n Parabola
# lvcreate -l 100%FREE MyVol -n Home
</code></pre>
<p>In this example, we create an 8GB swap partition, a 15GB root partition and a home partition filling up the rest of the space.</p>
<p>Format you filesystems:</p>
<pre><code># mkfs.ext4 /dev/mapper/MyVol-Parabola
# mkfs.ext4 /dev/mapper/MyVol-Home
# mkswap /dev/mapper/MyVol-swap
</code></pre>
<h4>Setup the boot partition</h4>
<p>Encrypt the <code>/boot</code> partition:</p>
<pre><code># cryptsetup luksFormat /dev/sdaY
</code></pre>
<p>Open this partition:</p>
<pre><code># cryptsetup open --type luks /dev/sdaY cryptboot
</code></pre>
<p>Create a filesystem on the partition (any filesystem that can be read by the bootloader is eligible; in this case EXT2 is used):</p>
<pre><code># mkfs.ext2 /dev/mapper/cryptboot
</code></pre>
<p>Mount the partition to <code>/mnt/boot</code>:</p>
<pre><code># mount /dev/mapper/cryptboot /mnt/boot
</code></pre>
<p>Create a mountpoint for the EFI System Partition (/dev/sdaX) and mount it:</p>
<pre><code># mkdir /mnt/boot/efi
# mount /dev/sdaX /mnt/boot/efi
</code></pre>
<p>At this point, follow the normal installation guide (https://wiki.parabola.nu/Installation_Guide) or the Beginner's Guide (https://wiki.parabola.nu/Beginners%27_guide) up to the <em>mkinitcpio</em> step.</p>
<h3>Configuring mkinitcpio</h3>
<p>Add the encrypt and lvm2 hooks to mkinitcpio.conf. Note that I also added <code>keymap</code> and <code>consolefont</code> in order to support different keymaps and fonts during boot:</p>
<pre><code>/etc/mkinitcpio.conf

HOOKS="... keymap consolefont encrypt lvm2 ... filesystems ..."
</code></pre>
<p>Regenerate the linux image:</p>
<pre><code># mkinitcpio -p linux-libre
</code></pre>
<p>Configuring the boot loader</p>
<p>Configure GRUB to recognize the LUKS encrypted /boot partition and unlock the encrypted root partition at boot:</p>
<pre><code>/etc/default/grub
--------------------------------------------------------------------------------------
GRUB_CMDLINE_LINUX="... cryptdevice=/dev/sdaZ:lvm root=/dev/mapper/MyVol-Parabola ..."
GRUB_ENABLE_CRYPTODISK=y
</code></pre>
<p>Generate GRUB's configuration file and install to the mounted ESP:</p>
<pre><code># grub-mkconfig -o /boot/grub/grub.cfg
# grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=grub --recheck
</code></pre>
<p>If this finished without errors, GRUB should prompt for the passphrase to unlock the /boot partition after the next reboot.</p>
<h3>Configuring crypttab</h3>
<p>This section deals with extra configuration to let the system mount the encrypted /boot.</p>
<p>While GRUB asks for a passphrase to unlock the encrypted <code>/boot</code> after above instructions, the partition unlock is not passed on to the initramfs. Hence, <code>/boot</code> will not be available after the system has re-/booted, because the encrypt hook only unlocks the system's root.</p>
<p>If you used the genfstab script during installation, it will have generated <code>/etc/fstab</code> entries for the <code>/boot</code> and <code>/boot/efi</code> mount points already, but the system will fail to find the generated device mapper for the boot partition. To make it available, add it to <code>crypttab</code>. For example:</p>
<pre><code>/etc/crypttab
------------------------------------------
cryptboot  /dev/sdaY      none        luks
</code></pre>
<p>Now you should be able to boot into you new encrypted installation of Parabola GNU/Linux-libre.</p>
<p>Note: You need to give your decryption password three times during boot. This is normal and there are ways to get around it, but they are beyond the scope of this article.</p>
<h2>2. Making a Usable System</h2>
<h3>Sound</h3>
<p>Install alsa-utils:</p>
<pre><code># pacman -S alsa-utils
</code></pre>
<p>Configure the sound card by editing /etc/asound.conf:</p>
<pre><code>/etc/asound.conf
----------------
pcm.!default {
    type hw
    card 1
}

ctl.!default {
    type hw
    card 1
}
</code></pre>
<p>Note: when using the audio plugin in the XFCE panel, right-click on it and click on properties, then change the sound card there, so that it also uses this sound card.</p>
</body>
</html>
